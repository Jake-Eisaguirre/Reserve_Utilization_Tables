---
title: "reserve_utl"
format: html
editor: source
---

```{r}
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

# librarian downloads, if not already downloaded, and reads in needed packages
librarian::shelf(tidyverse, here, DBI, odbc, padr)

```

```{r}
raw_date <- Sys.Date()

previous_bid_period <- substr(as.character((raw_date - 30)), 1, 7)

update_dt_rlv <- paste0(substr(as.character((raw_date - 60)), 1, 7), "-25 00:00:00")

```


```{r}
tryCatch({
    db_connection <- DBI::dbConnect(odbc::odbc(),
                             Driver="SnowflakeDSIIDriver",
                             Server="hawaiianair.west-us-2.azure.snowflakecomputing.com",
                             WAREHOUSE="DATA_LAKE_READER",
                             Database="ENTERPRISE",
                             UID= Sys.getenv("UID"), 
                             authenticator = "externalbrowser")
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
})

# Set search_path
dbExecute(db_connection, "USE SCHEMA CREW_ANALYTICS")


q_bid_periods <- "SELECT DISTINCT BID_PERIOD FROM CT_MASTER_HISTORY ORDER BY BID_PERIOD DESC;"
bid_periods <- dbGetQuery(db_connection, q_bid_periods)



# q_master_history <- paste0("select * from CT_MASTER_HISTORY")
# 
# 
# master_history_raw <- dbGetQuery(db_connection, q_master_history)

```

```{r}

utl_df <- data.frame()

# Loop over bases
  for (i in seq_along(bid_periods$BID_PERIOD)) { 
    
    q_master_history <- paste0("SELECT * FROM CT_MASTER_HISTORY WHERE BID_PERIOD = '", bid_periods$BID_PERIOD[i], "';")
    
    master_history_raw <- dbGetQuery(db_connection, q_master_history) %>%
      mutate(UPDATE_TIME = as.character(UPDATE_TIME),
             UPDATE_DATE = as.character(UPDATE_DATE))
    
    
    update_dt_rlv <- paste0((as_datetime(paste0(bid_periods$BID_PERIOD[i], "-24 00:00:00")) - months(1)), " 00:00:00") 

    

    fa_ut_rlv <- master_history_raw %>% 
      ungroup() %>% 
      filter(CREW_INDICATOR == "FA") %>% 
      filter(TRANSACTION_CODE %in% c("RSV", "RLV")) %>%
      mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>%
      filter(update_dt < update_dt_rlv) %>%
      group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>%
      mutate(temp_id = cur_group_id()) %>%
      filter(!duplicated(temp_id)) %>%
      ungroup() %>% 
      select(CREW_INDICATOR, CREW_ID, TRANSACTION_CODE,
             PAIRING_DATE, TO_DATE, PAIRING_POSITION, BID_PERIOD, BASE) %>% 
      mutate(EQUIPMENT = "NA")
    
    utl_df <- rbind(fa_ut_rlv, utl_df)
    
    
    print(paste0("Completed BID_PERIOD: ", bid_periods$BID_PERIOD[i]))
    
}

```


```{r}

# Connect to the `PLAYGROUND` database and append data if necessary
tryCatch({
  db_connection_pg <- DBI::dbConnect(odbc::odbc(),
                                     Driver = "SnowflakeDSIIDriver",
                                     Server = "hawaiianair.west-us-2.azure.snowflakecomputing.com",
                                     WAREHOUSE = "DATA_LAKE_READER",
                                     Database = "PLAYGROUND",
                                     UID = "jacob.eisaguirre@hawaiianair.com",
                                     authenticator = "externalbrowser")
  print("Database Connected!")
}, error = function(cond) {
  print("Unable to connect to Database.")
})

# Set schema and retrieve data from `AA_FINAL_PAIRING` table
dbExecute(db_connection_pg, "USE SCHEMA CREW_ANALYTICS")

dbWriteTable(db_connection_pg, "AA_RESERVE_UTILIZATION", utl_df, overwrite=T)

```

